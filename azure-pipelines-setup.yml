trigger: none
pr: none

variables:
  - group: LabConfiguration

stages:
  - stage: Setup
    displayName: 'DNS Lab - Setup'
    jobs:
      - job: SetupLab
        displayName: 'Setup Lab Environment'
        pool:
          name: 'ADO-Pipeline-Network-Troubleshooting-Labs-Pool'
        steps:
          - checkout: self
            fetchDepth: 1

          - script: |
              echo "=== Lab Setup Pipeline ==="
              echo "Triggered by: $(Build.RequestedFor)"
              echo "Build ID: $(Build.BuildId)"
            displayName: 'Display Context'

          - script: |
              curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
              wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
              echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
              sudo apt-get update && sudo apt-get install -y terraform jq
            displayName: 'Install Azure CLI, Terraform, and jq'

          - script: |
              echo "=== DEBUG: Variable Group Values ==="
              echo "ADO_ORG_URL: $(ADO_ORG_URL)"
              echo "ADO_PROJECT: $(ADO_PROJECT)"
              echo "ADO_POOL: $(ADO_POOL)"
              echo "AZURE_TENANT: $(AZURE_TENANT)"
              echo "===================================="
            displayName: 'Debug: Check Variables'

          - task: DownloadSecureFile@1
            name: sshKey
            displayName: 'Download SSH Key'
            inputs:
              secureFile: 'terraform_lab_key'
            continueOnError: true

          - task: AzureCLI@2
            displayName: 'Setup Lab Environment'
            inputs:
              azureSubscription: 'LabConnection'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              workingDirectory: '$(Build.SourcesDirectory)'
              inlineScript: |
                set -e
                
                # Ensure we are in the repo root
                cd "$(Build.SourcesDirectory)"
                SOURCE_DIR="$(pwd)"
                echo "Working Directory: $SOURCE_DIR"
                ls -la
                
                # Export variables
                export ADO_ORG_URL="$(ADO_ORG_URL)"
                export ADO_PAT="$(ADO_PAT)"
                export ADO_PROJECT="$(ADO_PROJECT)"
                # Force the target pool for the lab agent to be DNS-Lab-Pool
                export ADO_POOL="DNS-Lab-Pool"
                # Handle AZURE_TENANT safely (it might be missing from variable group)
                if [ -n "$(AZURE_TENANT)" ] && [ "$(AZURE_TENANT)" != "\$(AZURE_TENANT)" ]; then
                  export AZURE_TENANT="$(AZURE_TENANT)"
                else
                  echo "âš ï¸ AZURE_TENANT not found in variables, using default or empty"
                  export AZURE_TENANT=""
                fi
                export REQUESTED_FOR="$(Build.RequestedFor)"
                
                echo "=== Debug: Checking Scripts Directory ==="
                ls -la scripts/
                
                echo "=== [1] Checking Prerequisites ==="
                for tool in az terraform jq ssh; do
                  if ! command -v "$tool" > /dev/null 2>&1; then
                    echo "âŒ Missing tool: $tool"
                    exit 1
                  else
                    echo "âœ… Found: $tool"
                  fi
                done
                
                echo ""
                echo "=== [2] Checking Azure Login ==="
                if ! az account show > /dev/null 2>&1; then
                  echo "âŒ Not logged in to Azure"
                  exit 1
                fi
                SUB_NAME=$(az account show --query name -o tsv)
                SUB_ID=$(az account show --query id -o tsv)
                echo "âœ… Logged in to: $SUB_NAME ($SUB_ID)"
                
                echo ""
                echo "=== [3] Configuring Azure DevOps ==="
                echo "ADO_ORG_URL: $ADO_ORG_URL"
                echo "ADO_PROJECT: $ADO_PROJECT"
                echo "ADO_POOL: $ADO_POOL"
                echo "Pool configured: $ADO_POOL (self-hosted). Agent registration required."
                
                if [ -z "$ADO_ORG_URL" ] || [ -z "$ADO_PAT" ] || [ -z "$ADO_PROJECT" ] || [ -z "$ADO_POOL" ]; then
                  echo "âŒ ERROR: Missing required ADO variables in variable group"
                  exit 1
                fi
                
                # Save ADO config to .ado.env
                cat > "${SOURCE_DIR}/.ado.env" << 'EOF'
                ADO_ORG_URL="$ADO_ORG_URL"
                ADO_PAT="$ADO_PAT"
                ADO_PROJECT="$ADO_PROJECT"
                ADO_POOL="$ADO_POOL"
                AZURE_TENANT="$AZURE_TENANT"
                EOF
                
                export AZURE_DEVOPS_EXT_PAT="$ADO_PAT"
                echo "âœ… ADO configuration saved"
                
                echo ""
                echo "=== [4] Handling SSH Key ==="
                mkdir -p "$HOME/.ssh"
                chmod 700 "$HOME/.ssh"
                
                if [ -f "$(sshKey.secureFilePath)" ]; then
                    echo "âœ… Found existing SSH key in Secure Files"
                    cp "$(sshKey.secureFilePath)" "$HOME/.ssh/terraform_lab_key"
                    chmod 600 "$HOME/.ssh/terraform_lab_key"
                    
                    # Handle encrypted key if password is provided
                    if [ -n "$SSH_PASSWORD" ]; then
                        echo "ðŸ” Decrypting SSH key for automation use..."
                        # Remove passphrase for non-interactive use
                        ssh-keygen -p -f "$HOME/.ssh/terraform_lab_key" -P "$SSH_PASSWORD" -N "" || {
                            echo "âŒ Failed to decrypt SSH key with provided password"
                            exit 1
                        }
                        echo "âœ… SSH key decrypted"
                    fi

                    # Generate public key from private key
                    ssh-keygen -y -f "$HOME/.ssh/terraform_lab_key" > "$HOME/.ssh/terraform_lab_key.pub"
                    echo "âœ… Public key derived from secure file"
                else
                    echo "âš ï¸ No SSH key found in Secure Files. Generating new key..."
                    cd "$SOURCE_DIR"
                    chmod +x ./scripts/generate-ssh-key.sh
                    ./scripts/generate-ssh-key.sh --force
                    echo "âœ… New SSH key generated"
                    echo "âš ï¸ NOTE: You should upload '$HOME/.ssh/terraform_lab_key' to Secure Files as 'terraform_lab_key' for future runs."
                fi
                
                # Update terraform.tfvars with SSH public key
                SSH_PUB_KEY=$(cat "$HOME/.ssh/terraform_lab_key.pub")
                TFVARS_FILE="terraform.tfvars"
                if grep -q "^admin_ssh_key" "$TFVARS_FILE"; then
                  ESCAPED_KEY=$(echo "$SSH_PUB_KEY" | sed 's|/|\\/|g')
                  sed -i "s|^admin_ssh_key.*|admin_ssh_key = \"$ESCAPED_KEY\"|" "$TFVARS_FILE"
                else
                  echo "admin_ssh_key = \"$SSH_PUB_KEY\"" >> "$TFVARS_FILE"
                fi
                
                echo ""
                echo "=== [5] Deploying Infrastructure (Terraform) ==="
            env:
              SSH_PASSWORD: $(SSH_PASSWORD)
                
                # Update terraform.tfvars with ADO variables
                if grep -q "^ado_org_url" "$TFVARS_FILE"; then
                  sed -i "s|^ado_org_url.*|ado_org_url = \"$ADO_ORG_URL\"|" "$TFVARS_FILE"
                else
                  echo "ado_org_url = \"$ADO_ORG_URL\"" >> "$TFVARS_FILE"
                fi
                
                if grep -q "^ado_pat" "$TFVARS_FILE"; then
                  sed -i "s|^ado_pat.*|ado_pat = \"$ADO_PAT\"|" "$TFVARS_FILE"
                else
                  echo "ado_pat = \"$ADO_PAT\"" >> "$TFVARS_FILE"
                fi
                
                if grep -q "^ado_pool_name" "$TFVARS_FILE"; then
                  sed -i "s|^ado_pool_name.*|ado_pool_name = \"$ADO_POOL\"|" "$TFVARS_FILE"
                else
                  echo "ado_pool_name = \"$ADO_POOL\"" >> "$TFVARS_FILE"
                fi
                
                # Initialize Terraform if needed
                if [ ! -d ".terraform" ]; then
                  echo "â†’ Initializing Terraform..."
                  terraform init
                  echo "âœ… Terraform initialized"
                fi
                
                # Plan and apply
                echo "â†’ Planning infrastructure deployment..."
                terraform plan -out=tfplan -detailed-exitcode -compact-warnings || true
                
                echo "â†’ Deploying Azure resources (this takes ~5-7 minutes)..."
                echo "  Resources: Resource Group, VNet, Subnet, NSGs, Key Vault, Private Endpoint, DNS Zone, VM..."
                terraform apply -auto-approve tfplan
                
                echo "âœ… Infrastructure deployed"
                
                echo ""
                echo "=== [6] Configuring Pipeline ==="
                echo "â†’ Creating Azure DevOps service connection and pipeline..."
                chmod +x ./scripts/setup-pipeline.sh
                ./scripts/setup-pipeline.sh
                echo "âœ… Pipeline configured"
                
                echo ""
                echo "=== [7] Validating Lab Environment ==="
                chmod +x ./scripts/validate-base.sh
                ./scripts/validate-base.sh
                
                echo ""
                echo "=== Lab Setup Complete ==="
                echo "All infrastructure and pipelines are ready."
                echo "Agents run in self-hosted pool: DNS-Lab-Pool"
                echo "If no agent is present, run ./scripts/register-agent.sh after infrastructure deploy"
                echo "Next: See labs/lab1/README.md to start Lab 1"
                echo "Cleanup: Run ./destroy.sh when finished"

trigger: none
pr: none

variables:
  - group: LabConfiguration

stages:
  - stage: Setup
    displayName: 'DNS Lab - Setup'
    jobs:
      - job: SetupLab
        displayName: 'Setup Lab Environment'
        pool:
          name: 'ADO-Pipeline-Network-Troubleshooting-Labs-Pool'
        steps:
          - checkout: self
            fetchDepth: 1

          - script: |
              echo "=== Lab Setup Pipeline ==="
              echo "Triggered by: $(Build.RequestedFor)"
              echo "Build ID: $(Build.BuildId)"
            displayName: 'Display Context'

          - script: |
              curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
              wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
              echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
              sudo apt-get update && sudo apt-get install -y terraform jq
            displayName: 'Install Azure CLI, Terraform, and jq'

          - script: |
              echo "=== DEBUG: Variable Group Values ==="
              echo "ADO_ORG_URL: $(ADO_ORG_URL)"
              echo "ADO_PROJECT: $(ADO_PROJECT)"
              echo "ADO_POOL: $(ADO_POOL)"
              echo "AZURE_TENANT: $(AZURE_TENANT)"
              echo "===================================="
            displayName: 'Debug: Check Variables'

          - task: DownloadSecureFile@1
            name: sshKey
            displayName: 'Download SSH Key from Secure Files'
            inputs:
              secureFile: 'terraform_lab_key'
            continueOnError: true

          - script: |
              echo "=== Checking Prerequisites ==="
              for tool in az terraform jq ssh; do
                if ! command -v "$tool" > /dev/null 2>&1; then
                  echo "❌ Missing tool: $tool"
                  exit 1
                else
                  echo "✅ Found: $tool"
                fi
              done
            displayName: '1. Check Prerequisites'
            workingDirectory: '$(Build.SourcesDirectory)'

          - task: AzureCLI@2
            displayName: '2. Verify Azure Login'
            inputs:
              azureSubscription: 'LabConnection'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                SUB_NAME=$(az account show --query name -o tsv)
                SUB_ID=$(az account show --query id -o tsv)
                echo "✅ Logged in to: $SUB_NAME ($SUB_ID)"

          - script: |
              echo "=== Configuring Azure DevOps ==="
              echo "ADO_ORG_URL: $(ADO_ORG_URL)"
              echo "ADO_PROJECT: $(ADO_PROJECT)"
              echo "ADO_POOL: DNS-Lab-Pool"
              
              if [ -z "$(ADO_ORG_URL)" ] || [ -z "$(ADO_PAT)" ] || [ -z "$(ADO_PROJECT)" ]; then
                echo "❌ ERROR: Missing required ADO variables in variable group"
                exit 1
              fi
              
              # Save ADO config to .ado.env
              cat > .ado.env << 'EOFADO'
              ADO_ORG_URL="$(ADO_ORG_URL)"
              ADO_PAT="$(ADO_PAT)"
              ADO_PROJECT="$(ADO_PROJECT)"
              ADO_POOL="DNS-Lab-Pool"
              EOFADO
              
              echo "✅ ADO configuration saved to .ado.env"
            displayName: '3. Configure Azure DevOps'
            workingDirectory: '$(Build.SourcesDirectory)'

          - script: |
              echo "=== Handling SSH Key ==="
              mkdir -p "$HOME/.ssh"
              chmod 700 "$HOME/.ssh"
              
              if [ -f "$(sshKey.secureFilePath)" ]; then
                  echo "✅ Found SSH key in Secure Files"
                  cp "$(sshKey.secureFilePath)" "$HOME/.ssh/terraform_lab_key"
                  chmod 600 "$HOME/.ssh/terraform_lab_key"
                  
                  # Generate public key from private key (no password needed)
                  ssh-keygen -y -f "$HOME/.ssh/terraform_lab_key" > "$HOME/.ssh/terraform_lab_key.pub"
                  echo "✅ Public key derived from secure file"
              else
                  echo "⚠️ No SSH key found in Secure Files. Generating new key..."
                  chmod +x ./scripts/generate-ssh-key.sh
                  ./scripts/generate-ssh-key.sh --force
                  echo "✅ New SSH key generated"
                  echo "⚠️ Upload ~/.ssh/terraform_lab_key to Secure Files as 'terraform_lab_key' for future runs"
              fi
              
              # Show public key for reference
              echo ""
              echo "Public Key:"
              cat "$HOME/.ssh/terraform_lab_key.pub"
            displayName: '4. Setup SSH Key'
            workingDirectory: '$(Build.SourcesDirectory)'

          - script: |
              echo "=== Updating terraform.tfvars ==="
              
              # Update with SSH public key
              SSH_PUB_KEY=$(cat "$HOME/.ssh/terraform_lab_key.pub")
              if grep -q "^admin_ssh_key" terraform.tfvars; then
                ESCAPED_KEY=$(echo "$SSH_PUB_KEY" | sed 's|/|\\/|g')
                sed -i "s|^admin_ssh_key.*|admin_ssh_key = \"$ESCAPED_KEY\"|" terraform.tfvars
              else
                echo "admin_ssh_key = \"$SSH_PUB_KEY\"" >> terraform.tfvars
              fi
              
              # Update with ADO variables
              if grep -q "^ado_org_url" terraform.tfvars; then
                sed -i "s|^ado_org_url.*|ado_org_url = \"$(ADO_ORG_URL)\"|" terraform.tfvars
              else
                echo "ado_org_url = \"$(ADO_ORG_URL)\"" >> terraform.tfvars
              fi
              
              if grep -q "^ado_pat" terraform.tfvars; then
                sed -i "s|^ado_pat.*|ado_pat = \"$(ADO_PAT)\"|" terraform.tfvars
              else
                echo "ado_pat = \"$(ADO_PAT)\"" >> terraform.tfvars
              fi
              
              if grep -q "^ado_pool_name" terraform.tfvars; then
                sed -i "s|^ado_pool_name.*|ado_pool_name = \"DNS-Lab-Pool\"|" terraform.tfvars
              else
                echo "ado_pool_name = \"DNS-Lab-Pool\"" >> terraform.tfvars
              fi
              
              echo "✅ terraform.tfvars updated"
            displayName: '5. Update Terraform Variables'
            workingDirectory: '$(Build.SourcesDirectory)'

          - task: AzureCLI@2
            displayName: '6. Deploy Infrastructure (Terraform)'
            inputs:
              azureSubscription: 'LabConnection'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              workingDirectory: '$(Build.SourcesDirectory)'
              inlineScript: |
                set -e
                
                # Initialize Terraform if needed
                if [ ! -d ".terraform" ]; then
                  echo "→ Initializing Terraform..."
                  terraform init
                  echo "✅ Terraform initialized"
                fi
                
                # Plan
                echo "→ Planning infrastructure deployment..."
                terraform plan -out=tfplan -detailed-exitcode -compact-warnings || true
                
                # Apply
                echo "→ Deploying Azure resources (this takes ~5-7 minutes)..."
                echo "  Resources: Resource Group, VNet, Subnet, NSGs, Key Vault, Private Endpoint, DNS Zone, VM..."
                terraform apply -auto-approve tfplan
                
                echo "✅ Infrastructure deployed"

          - task: AzureCLI@2
            displayName: '7. Configure Pipeline'
            inputs:
              azureSubscription: 'LabConnection'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              workingDirectory: '$(Build.SourcesDirectory)'
              inlineScript: |
                set -e
                export AZURE_DEVOPS_EXT_PAT="$(ADO_PAT)"
                export ADO_ORG_URL="$(ADO_ORG_URL)"
                export ADO_PAT="$(ADO_PAT)"
                export ADO_PROJECT="$(ADO_PROJECT)"
                export ADO_POOL="DNS-Lab-Pool"
                
                echo "→ Creating Azure DevOps service connection and pipeline..."
                chmod +x ./scripts/setup-pipeline.sh
                ./scripts/setup-pipeline.sh
                echo "✅ Pipeline configured"

          - task: AzureCLI@2
            displayName: '8. Validate Lab Environment'
            inputs:
              azureSubscription: 'LabConnection'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              workingDirectory: '$(Build.SourcesDirectory)'
              inlineScript: |
                set -e
                chmod +x ./scripts/validate-base.sh
                ./scripts/validate-base.sh
                
                echo ""
                echo "=== Lab Setup Complete ==="
                echo "All infrastructure and pipelines are ready."
                echo "Agents run in self-hosted pool: DNS-Lab-Pool"
                echo "Run ./scripts/register-agent.sh to register the lab agent"
                echo "Next: See labs/lab1/README.md to start Lab 1"
